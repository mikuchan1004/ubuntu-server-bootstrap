#!/usr/bin/env bash
# Custom MOTD (Korean) - server status summary

set -euo pipefail

# ëŸ°íƒ€ìž„ ìºì‹œ( sudo/suë¡œ SSH_* í™˜ê²½ë³€ìˆ˜ê°€ ì‚¬ë¼ì ¸ë„ IP ìœ ì§€ )
CACHE_DIR="/run/motd"
CACHE_USER="${SUDO_USER:-${USER:-unknown}}"
CACHE_FILE="${CACHE_DIR}/login_${CACHE_USER}.ip"

mkdir -p "$CACHE_DIR" 2>/dev/null || true

get_client_ip() {
  # SSH ì ‘ì†ì´ë©´ ì´ê²Œ ì œì¼ ì •í™•
  if [[ -n "${SSH_CLIENT:-}" ]]; then
    echo "${SSH_CLIENT%% *}"
    return
  fi
  if [[ -n "${SSH_CONNECTION:-}" ]]; then
    echo "${SSH_CONNECTION%% *}"
    return
  fi

  # sudo/suë¡œ í™˜ê²½ì´ ì •ë¦¬ëì„ ë•ŒëŠ” ìºì‹œ ì‚¬ìš©
  if [[ -r "$CACHE_FILE" ]]; then
    cat "$CACHE_FILE"
    return
  fi

  echo "(ì½˜ì†”/ë¡œì»¬)"
}

get_login_user() {
  # rootë¡œ ìŠ¹ê²©ë˜ì–´ë„ â€œì›ëž˜ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìžâ€ í‘œì‹œ
  if [[ -n "${SUDO_USER:-}" ]]; then
    echo "${SUDO_USER}"
    return
  fi
  if [[ -n "${LOGNAME:-}" ]]; then
    echo "${LOGNAME}"
    return
  fi
  if [[ -n "${USER:-}" ]]; then
    echo "${USER}"
    return
  fi
  whoami
}

# SSH ì ‘ì†ì´ë©´ IP ìºì‹œ ì €ìž¥(ë‹¤ìŒ sudo/suì—ì„œë„ ìœ ì§€)
if [[ -n "${SSH_CLIENT:-}" ]]; then
  echo "${SSH_CLIENT%% *}" > "$CACHE_FILE" 2>/dev/null || true
fi

CLIENT_IP="$(get_client_ip)"
LOGIN_USER="$(get_login_user)"
RUN_AS="$(whoami)"

DISK_FREE="$(df -h / | awk 'NR==2 {print $4}')"
# free ì¶œë ¥ í¬ë§·ì´ ë‹¬ë¼ë„ í•­ìƒ ê°’ì´ ë‚˜ì˜¤ê²Œ ë§ˆì§€ë§‰ í•„ë“œ ì‚¬ìš©
MEM_AVAIL="$(free -h | awk '/^Mem:/ {print $NF}')"

echo "========================================"
echo " ðŸ–¥  ì„œë²„ ìƒíƒœ ìš”ì•½"
echo "----------------------------------------"
echo " ðŸ“… í˜„ìž¬ ì‹œê°„  : $(date '+%Y-%m-%d %H:%M:%S')"

if [[ "$LOGIN_USER" == "$RUN_AS" ]]; then
  echo " ðŸ‘¤ ë¡œê·¸ì¸ ê³„ì •: ${LOGIN_USER}"
else
  echo " ðŸ‘¤ ë¡œê·¸ì¸ ê³„ì •: ${LOGIN_USER} (í˜„ìž¬ ê¶Œí•œ: ${RUN_AS})"
fi

echo " ðŸŒ ì ‘ì† IP    : ${CLIENT_IP}"
echo " â±  ì—…íƒ€ìž„     : $(uptime -p)"
echo " ðŸ’¾ ë””ìŠ¤í¬(/)  : ${DISK_FREE} ì—¬ìœ "
echo " ðŸ§  ë©”ëª¨ë¦¬     : ${MEM_AVAIL} ì—¬ìœ "

# Fail2Ban ìƒíƒœ + ì°¨ë‹¨ IP ëª©ë¡ (rootë§Œ ê°€ëŠ¥)
if [[ "$(id -u)" -eq 0 ]]; then
  BANNED="$(timeout 1 fail2ban-client status sshd 2>/dev/null | awk -F': ' '/Currently banned/ {print $2}')"
  [[ -n "$BANNED" ]] || BANNED="0"
  echo " ðŸ” Fail2Ban   : ${BANNED} IP ì°¨ë‹¨ ì¤‘"

  if [[ "$BANNED" != "0" ]]; then
    IPS="$(timeout 1 fail2ban-client get sshd banip 2>/dev/null | tr -s ' ' | sed 's/^ //;s/ $//')"
    if [[ -n "$IPS" ]]; then
      COUNT="$(wc -w <<<"$IPS" | tr -d ' ')"
      if [[ "$COUNT" -le 6 ]]; then
        echo " ðŸ§± ì°¨ë‹¨ IP    : ${IPS}"
      else
        HEAD6="$(awk '{for(i=1;i<=6;i++) printf "%s%s",$i,(i<6?" ":"");}' <<<"$IPS")"
        echo " ðŸ§± ì°¨ë‹¨ IP    : ${HEAD6} ... (+$((COUNT-6)) more)"
      fi
    else
      echo " ðŸ§± ì°¨ë‹¨ IP    : (ëª©ë¡ ì¡°íšŒ ë¶ˆê°€)"
    fi
  fi
else
  echo " ðŸ” Fail2Ban   : (ê¶Œí•œ ì—†ìŒ)"
fi

echo "========================================"
